# 原神数据查询系统

[api介绍]:https://apifox.com/apidoc/shared-c7e83bcb-2155-4f86-ae7a-6719adbd0893
[后端端口]:https://10.79.139.228:7275/swagger
[前端端口]:http://10.78.109.239:3000/#/home



## 一、项目背景&创新性

### 1.项目背景

- 原神
  - 《原神》是由米哈游自主研发的一款全新开放世界冒险游戏。游戏发生在一个被称作「提瓦特」的幻想世界，在这里，被神选中的人将被授予「神之眼」，导引元素之力。你将扮演一位名为「旅行者」的神秘角色，在自由的旅行中邂逅性格各异、能力独特的同伴们，和他们一起击败强敌，找回失散的亲人——同时，逐步发掘「原神」的真相。
- 系统涉及核心游戏元素
  - 深渊
    - 玩家在游戏中抽取喜欢的角色，搭配队伍进行挑战。该系统将基于开源数据，给出当前深渊队伍登场率排行榜，为玩家的配队和角色养成提供参考。
  - 圣遗物副本
    - 原神角色练度主要由命座、天赋、武器、圣遗物组成，其中圣遗物为比较肝的部分，需要花费大量时间提高该部分的属性加成。圣遗物因种类的不同而提供不同的主副词条，不同的圣遗物副本会在特定时间开放。该系统将基于开源数据，为玩家提供当天所开放圣遗物副本和适用的角色，玩家可选择需要的圣遗物副本进行挑战。
  - 材料副本
    - 角色、天赋、武器在突破/升级/进阶阶段需要特定的材料，而有些材料只能通过在特定时间开放的副本进行获取。该系统基于开源数据，为玩家提供当天所开放材料副本和适用的角色/武器，玩家可选择需要的材料副本进行挑战。



## 2.系统功能介绍

- 深渊配队查询

  - 范围：本期数据、上期数据的所有队伍查询
  - 指标：角色在上期使用数、当前使用数、上期使用率、当前使用率、变化率

- 材料查询

  - 范围：今日、明日
  - 涵盖：圣遗物副本、角色突破材料副本、角色天赋材料副本、武器进阶材料副本
  - 指标：种类、适用角色/武器

  



### 3.项目创新性

- ==一款功能明确、职责专一的轻量级原神数据系统==

- **职责专一**
  - 系统专一化，主要关注原神游戏中的每日材料&圣遗物和深渊热门配队两方面。相较于同类型系统更加精炼，用户可以快速查找并获取他们关心的信息，而不必被其他无关的数据信息混淆。
- **功能明确**
  - 每个功能模块都有明确的目标，例如每日副本系统专注于提供用户可获取的圣遗物信息，而深渊热门配队系统专注于展示深渊中表现出色的配队。功能的明确性使用户能够迅速地了解并使用系统
- **轻量级**原神数据系统
- **用户友好的界面设计**
  - 创新不仅仅体现在功能上，还包括用户体验。你们的系统在界面设计上可能采用了直观的图表、图形化展示，以及友好的交互方式，使用户能够轻松地浏览和理解数据。这种用户友好的设计可以提高系统的可用性，吸引更多玩家使用。
- **智能的数据更新机制**
  - 每当版本变更，原神中的数据会随之更新，我们的系统采用了智能的数据更新机制，确保系统中的数据始终是最新的。保证了用户获取到准确的信息，提高系统的可信度和实用性。
- **记录用户上次查询使用的UID**
  - 记录功能，方便用户在下次打开系统时进行查询操作。
- **数据库设计创新性**
  - 





## 二、前后端设计









## 三、数据库设计









## 四、SQL语句

- 数据表创建

  - ```Mysql
    CREATE TABLE `AbyssRecords` (
        `Id` int NOT NULL AUTO_INCREMENT,
        `Uid` longtext CHARACTER SET utf8mb4 NOT NULL,
        `UploadTime` bigint NOT NULL,
        CONSTRAINT `PK_AbyssRecords` PRIMARY KEY (`Id`)
    ) CHARACTER SET=utf8mb4;
    CREATE TABLE `Talents` (
        `Id` int NOT NULL AUTO_INCREMENT,
        `Name` longtext CHARACTER SET utf8mb4 NOT NULL,
        `Days` int NOT NULL,
        CONSTRAINT `PK_Talents` PRIMARY KEY (`Id`)
    ) CHARACTER SET=utf8mb4;
    CREATE TABLE `Version` (
        `Id` int NOT NULL AUTO_INCREMENT,
        `Ver` longtext CHARACTER SET utf8mb4 NOT NULL,
        `StartDate` bigint NOT NULL,
        `EndDate` bigint NOT NULL,
        CONSTRAINT `PK_Version` PRIMARY KEY (`Id`)
    ) CHARACTER SET=utf8mb4;
    CREATE TABLE `Characters` (
        `Id` int NOT NULL AUTO_INCREMENT,
        `Name` varchar(64) CHARACTER SET utf8mb4 NOT NULL,
        `TalentId` int NOT NULL,
        CONSTRAINT `PK_Characters` PRIMARY KEY (`Id`),
        CONSTRAINT `FK_Characters_Talents_TalentId` FOREIGN KEY (`TalentId`) REFERENCES `Talents` (`Id`) ON DELETE CASCADE
    ) CHARACTER SET=utf8mb4;
    CREATE TABLE `CharacterRecords` (
        `Id` int NOT NULL AUTO_INCREMENT,
        `CharacterId` int NOT NULL,
        `AbyssRecordId` int NOT NULL,
        `Part` int NOT NULL,
        CONSTRAINT `PK_CharacterRecords` PRIMARY KEY (`Id`),
        CONSTRAINT `FK_CharacterRecords_AbyssRecords_AbyssRecordId` FOREIGN KEY (`AbyssRecordId`) REFERENCES `AbyssRecords` (`Id`) ON DELETE CASCADE,
        CONSTRAINT `FK_CharacterRecords_Characters_CharacterId` FOREIGN KEY (`CharacterId`) REFERENCES `Characters` (`Id`) ON DELETE CASCADE
    ) CHARACTER SET=utf8mb4;
    ```

- 查询角色天赋

  - ```Mysql
    select characters.id as CharacterId, talents.name as TalentName
        from characters join talents on characters.talentid = talents.id
        where talents.days = {today} or -1 = {today}
    ```

- 查询队伍信息

  - ```mysql
    select team, count(part = 0 or null) as firstHalf, count(part = 1 or null) as secondHalf from 
       	(select abyssrecordid, part, group_concat(characterid order by characterid asc separator ',') as team 
           	from characterrecords where (abyssrecordid, part) in
               		(select abyssrecordid, part from characterrecords
                    	where characterid = {characterId} or -1 = {characterId})
         		and abyssrecordid in
         			(select Id from AbyssRecords where
                     	UploadTime > (select any_value(StartDate) from Version where Ver = {version})
                    	and UploadTime < (select any_value(EndDate) from Version where Ver = {version}))
            	group by abyssrecordid, part) 
        as groups group by team;
    ```

- 查询

  - ```mysql
    select firstHalf, secondHalf, uploadtime from(
        select abyssrecords.id,
            abyssrecords.uploadtime,
            group_concat(characterrecords.characterid order by characterrecords.characterid asc separator ',') as firstHalf
            from abyssrecords join characterrecords on
                abyssrecords.id = characterrecords.abyssrecordid
            where abyssrecords.uid = {uid} and characterrecords.part = 0
            group by abyssrecords.id, abyssrecords.uploadtime
    	) as firstHalfTable
        join(
            select abyssrecords.id,
                group_concat(characterrecords.characterid order by characterrecords.characterid asc separator ',') as secondHalf
                from abyssrecords join characterrecords on
                    abyssrecords.id = characterrecords.abyssrecordid
                where abyssrecords.uid = {uid} and characterrecords.part = 1
                group by abyssrecords.id
        ) as secondHalfTable using (id);
    ```

- 查询

  - ```mysql
    select * from (
        select 1 as _, StartDate as PrevVersionStartDate, EndDate as PrevVersionEndDate from version where EndDate < 
            (select any_value(StartDate) from version where Ver = {version}) order by EndDate desc limit 1) as PrevVersion
    join (
        select 1 as _, StartDate as CurrentVersionStartDate, EndDate as CurrentVersionEndDate from version
            where Ver = {version}
    ) as CurrentVersion using(_);
    
    select characters.id,
       	(select count(*) from CharacterRecords where CharacterId = characters.id and abyssrecordid in
            	(select Id from AbyssRecords where
               	UploadTime > {versionDateTime.CurrentVersionStartDate}
                and UploadTime < {versionDateTime.CurrentVersionEndDate}))
       	as CurrentUsed,
       	(select count(*) from AbyssRecords where
               	UploadTime > {versionDateTi me.CurrentVersionStartDate}
                and UploadTime < {versionDateTime.CurrentVersionEndDate})
        as CurrentTotal,
        (select count(*) from CharacterRecords where CharacterId = characters.id and abyssrecordid in
            	(select Id from AbyssRecords where
               	UploadTime > {versionDateTime.PrevVersionStartDate}
                and UploadTime < {versionDateTime.PrevVersionEndDate}))
       	as PrevUsed,
       	(select count(*) from AbyssRecords where
               	UploadTime > {versionDateTime.PrevVersionStartDate}
                and UploadTime < {versionDateTime.PrevVersionEndDate})
        as PrevTotal
    from characters;
    ```

    



